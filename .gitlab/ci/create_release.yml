create_release:
  image: registry.gitlab.com/gitlab-org/cli:latest  # Aktualisiert auf v1.79.0
  tags: [docker]
  stage: release
  before_script:
    - apk add --no-cache make zip git jq  # `jq` fÃ¼r JSON-Manipulation
  script:
    # 1. Version bestimmen
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION=$CI_COMMIT_TAG
      else
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        COMMIT_SHORT=$(git rev-parse --short=8 HEAD)
        VERSION="$LAST_TAG-$COMMIT_SHORT"
      fi
      echo "VERSION=$VERSION" >> release.env

    # 2. Artefakte hochladen (z. B. Binaries)
    - mkdir -p releases
    - cp bin/markscribe-* releases/  # Beispiel: Kopiere alle Binaries
    - echo "ðŸ“¦ Artefakte vorbereitet: $(ls releases/)"

    # 3. Release-Notizen generieren
    - |
      echo "RELEASE_NOTES<<EOF" >> release.env
      ## ðŸš€ Release $VERSION

      **Changes since last release:**
      $(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~10")..HEAD)

      **Assets:**
      - Linux: \`markscribe-linux-amd64.tar.gz\`
      - macOS: \`markscribe-darwin-amd64.tar.gz\`
      EOF
      echo "" >> release.env

    # 4. Release mit `glab` erstellen (korrekte JSON-Struktur!)
    - |
      glab release create \
        --repo "$CI_PROJECT_PATH" \
        --tag-name "$VERSION" \
        --name "Release $VERSION" \
        --description "$(cat release.env | grep -A 20 'RELEASE_NOTES<<EOF' | tail -n 20)" \
        --assets-link '{
          "name": "Linux Binary",
          "url": "'"$CI_PROJECT_URL"'-/jobs/'"$CI_JOB_ID"'/artifacts/raw/releases/markscribe-linux-amd64.tar.gz"
        }' \
        --assets-link '{
          "name": "macOS Binary",
          "url": "'"$CI_PROJECT_URL"'-/jobs/'"$CI_JOB_ID"'/artifacts/raw/releases/markscribe-darwin-amd64.tar.gz"
        }'

  artifacts:
    paths:
      - releases/
    expire_in: 1 week

  rules:
    - if: $CI_COMMIT_TAG  # Automatisch fÃ¼r Tags
    - if: $CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"  # Optional: Manuell fÃ¼r master
      when: manual
      variables:
        VERSION: "nightly-$CI_COMMIT_SHORT_SHA"  # Beispiel: nightly-abc1234