create_release:
  image: registry.gitlab.com/gitlab-org/cli:v1.79.0  # Aktuelle Version mit allen Features
  tags: [docker]
  stage: release
  before_script:
    - apk add --no-cache make zip git jq
  script:
    - |
      # 1. Version bestimmen (Tag oder Fallback)
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION="$CI_COMMIT_TAG"
      else
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        COMMIT_SHORT=$(git rev-parse --short=8 HEAD)
        VERSION="$LAST_TAG-$COMMIT_SHORT"
      fi
      echo "VERSION=$VERSION" > release.env

    - |
      # 2. Release-Notizen generieren
      {
        echo "RELEASE_NOTES<<EOF"
        echo "# Release $VERSION"
        echo ""
        echo "## Changes"
        git log --pretty=format="- %s" "${LAST_TAG:-HEAD~10}"..HEAD | grep -v "Merge"
        echo ""
        echo "## Assets"
        echo "- [Linux Binary]($CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/raw/releases/markscribe-linux-amd64.tar.gz)"
        echo "- [macOS Binary]($CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/raw/releases/markscribe-darwin-amd64.tar.gz)"
        echo "EOF"
      } >> release.env

    - |
      # 3. Release erstellen (offizielle Syntax)
      glab release create "$VERSION" \
        --repo "$CI_PROJECT_PATH" \
        --name "Release $VERSION" \
        --notes "$(awk '/RELEASE_NOTES<<EOF/{flag=1;next}/EOF/{flag=0}flag' release.env)" \
        --assets-links='
          [
            {
              "name": "Linux Binary",
              "url": "'"$CI_PROJECT_URL"'-/jobs/'"$CI_JOB_ID"'/artifacts/raw/releases/markscribe-linux-amd64.tar.gz",
              "link_type": "other"
            },
            {
              "name": "macOS Binary",
              "url": "'"$CI_PROJECT_URL"'-/jobs/'"$CI_JOB_ID"'/artifacts/raw/releases/markscribe-darwin-amd64.tar.gz",
              "link_type": "other"
            }
          ]'

    - mkdir -p releases && cp bin/markscribe-* releases/ 2>/dev/null || true
  artifacts:
    paths:
      - releases/
      - release.env
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG'  # Automatisch bei Tags
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
      when: manual  # Manuell f√ºr main/master
