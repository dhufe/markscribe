create_github_package:
  stage: release
  image: quay.io/podman/stable
  tags: [docker]
  before_script:
    - echo "$GITHUB_TOKEN" | podman login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
  script:
    - |
      # Version bestimmen (Tag oder Fallback)
      if [ -n "$CI_COMMIT_TAG" ]; then
        VERSION=$CI_COMMIT_TAG
      else
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        COMMIT_SHORT=$(git rev-parse --short=8 HEAD)
        VERSION="$LAST_TAG-$COMMIT_SHORT"
      fi

      echo "üöÄ Building and pushing image: ghcr.io/dhufe/markscribe:$VERSION"

      # Build & Push mit Version-Tag
      podman build -t ghcr.io/dhufe/markscribe:$VERSION .
      podman push ghcr.io/dhufe/markscribe:$VERSION

      # Nur `latest` setzen, wenn es ein offizielles Release (Tag) ist
      if [ -n "$CI_COMMIT_TAG" ]; then
        podman tag ghcr.io/dhufe/markscribe:$VERSION ghcr.io/dhufe/markscribe:latest
        podman push ghcr.io/dhufe/markscribe:latest
        echo "‚úÖ Pushed 'latest' tag (official release)"
      else
        echo "‚ö†Ô∏è Skipping 'latest' tag (not an official release)"
      fi

  # Regeln f√ºr Ausf√ºhrung (Tags + manuell von main)
  rules:
    - if: $CI_COMMIT_TAG               # Automatisch f√ºr Tags (Releases)
    - if: $CI_COMMIT_BRANCH == "master"  # Manuell f√ºr main (Pre-Releases)
      when: manual

  # Variablen (sollten in GitLab CI/CD-Variablen definiert sein)
  variables:
    GITHUB_USERNAME: "dhufe"  # Oder √ºber CI/CD-Variable setzen
